using Godot;
using System;

/// <summary>
/// A chest that, when opened, permanently unlocks the Pistol weapon and equips it,
/// and grants an initial supply of ammo.
/// </summary>
public partial class Chest : Node2D // Changed class name from generic 'Chest'
{
	// --- Config ---
	// Define the weapon granted by this chest
	private const string WeaponName = "Pistol"; 
	
	// Default ammo to give upon pickup (Pistol usually starts with more ammo)
	[Export] public int AmmoAmount = 60; 
	[Export] public string InteractAction = "interact"; // Interaction input action

	private bool _playerInRange = false;
	private bool _isOpened = false;

	private AnimatedSprite2D _sprite;
	private Area2D _area;

	public override void _Ready()
	{
		_sprite = GetNode<AnimatedSprite2D>("AnimatedSprite2D");
		_area = GetNode<Area2D>("Area2D");

		const string CLOSED_ANIMATION = "closed";
		const string OPEN_ANIMATION = "open";
		
		var manager = GameManager.Instance;

		// CRITICAL: Check global state using the specific weapon name for persistence
		if (manager != null && manager.IsWeaponUnlocked(WeaponName))
		{
			// If already unlocked, start in the opened state and disable interaction
			_isOpened = true;
			if (_sprite.SpriteFrames.HasAnimation(OPEN_ANIMATION))
			{
				_sprite.Play(OPEN_ANIMATION);
				// Stop and hold on the last frame
				_sprite.Frame = _sprite.SpriteFrames.GetFrameCount(OPEN_ANIMATION) - 1;
				_sprite.Stop();
			}
			_area.Monitoring = false; // Disable interaction immediately
			return; // Skip signal connections
		}

		// Connect the signals
		_area.BodyEntered += OnBodyEntered;
		_area.BodyExited += OnBodyExited;

		// Set the default closed state
		if (_sprite.SpriteFrames.HasAnimation(CLOSED_ANIMATION))
		{
			_sprite.Play(CLOSED_ANIMATION);
		}
	}

	private void OnBodyEntered(Node2D body)
	{
		if (body.IsInGroup("player"))
			_playerInRange = true;
	}

	private void OnBodyExited(Node2D body)
	{
		if (body.IsInGroup("player"))
			_playerInRange = false;
	}

	public override void _Process(double delta)
	{
		if (_playerInRange && !_isOpened && Input.IsActionJustPressed(InteractAction))
			OpenChest();
	}

	private void OpenChest()
	{
		_isOpened = true;
		const string OPEN_ANIMATION = "open";

		if (_sprite.SpriteFrames.HasAnimation(OPEN_ANIMATION))
			_sprite.Play(OPEN_ANIMATION);

		GiveReward();
		
		_area.Monitoring = false;
		
		// Disconnect signals after use to prevent unexpected behavior
		_area.BodyEntered -= OnBodyEntered;
		_area.BodyExited -= OnBodyExited;
	}

	private void GiveReward()
	{
		var player = GetTree().GetFirstNodeInGroup("player") as CharacterNode;
		var manager = GameManager.Instance;

		if (player != null && manager != null)
		{
			// CRITICAL STEP 1: Permanently unlock the weapon in the global state
			manager.UnlockWeapon(WeaponName);
			
			// CRITICAL STEP 2: Equip the weapon immediately
			player.EquipWeapon(WeaponName);
			
			// Give the player the initial ammo amount
			player.GiveAmmo(AmmoAmount); 

			GD.Print($"{WeaponName} Chest opened. {WeaponName} unlocked and state saved globally!");
		}
		else
		{
			GD.PrintErr($"PistolChest failed to find Player ({player == null}) or GameManager ({manager == null}).");
		}
	}
}
